name: Manual preprod deploy
on:
  workflow_call:
    inputs:
      update_simbioz:
        required: true
        type: boolean
      base_update:
        required: false
        type: boolean
      SERVER_ADDR:
        required: true
        type: string
      SERVER_USER:
        required: true
        type: string
      MAIN_PATH:
        required: true
        type: string
      CUSTOM_PATH:
        required: true
        type: string
      ODOO_SERVICE:
        required: true
        type: string
      ODOO_USER:
        required: true
        type: string
      ODOO_URI:
        required: true
        type: string
      ODOO_DB:
        required: true
        type: string
    secrets:
      SSH_KEY:
        required: true
      ODOO_PASSWORD:
        required: true
jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      # - name: Checkout CI/CD repo
      #   uses: actions/checkout@v4
      #   with:
      #     repository: BorovlevAS/ci_cd_workflows
      #     ref: dev
      #     path: ci_cd_tools
      # - name: Install Python
      #   uses: actions/setup-python@v3
      #   with:
      #     python-version: '3.8.10'
      - name: Create SSH
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          echo $SERVER_ADDR
          ssh-keyscan -H $SERVER_ADDR > ~/.ssh/known_hosts
      #     echo "#!/bin/bash" > ~/update_script.sh
      # - name: Update from SIMBIOZ repo - prepare
      #   if: ${{inputs.update_simbioz}}
      #   run: |
      #     cat <<EOF >> ~/update_script.sh
      #     echo "=== UPDATING SIMBIOZ REPOs ==="
      #     cd $MAIN_PATH
      #     git submodule foreach --recursive git config --local --replace-all safe.directory '*'
      #     git submodule foreach --recursive git checkout main
      #     git submodule foreach --recursive 'git add . && git diff-index --quiet HEAD || (git stash && git stash drop)'
      #     git submodule foreach --recursive git reset --hard
      #     git submodule foreach --recursive git pull
      #     sh odoo_set_icons.sh || true
      #     EOF
      # - name: Update from BIKO repo - prepare
      #   env:
      #     PTH_STRING: ${{'$PTH'}}
      #   run: |
      #     cat <<EOF >> ~/update_script.sh
      #     echo "=== UPDATING BIKO REPOs ==="
      #     for PTH in {$CUSTOM_PATH}
      #     do
      #       cd $PTH_STRING
      #       pwd
      #       git checkout dev || git checkout main
      #       git add . && git diff-index --quiet HEAD || (git stash && git stash drop)
      #       git reset --hard
      #       git pull
      #     done
      #     EOF
      # - name: Soft update (only changes)
      #   if: ${{!inputs.base_update}}
      #   run: |
      #     cat <<EOF >> ~/update_script.sh
      #     echo "=== UPDATING ODOO ==="
      #     sudo systemctl restart $ODOO_SERVICE
      #     EOF
      #     ssh -o ServerAliveInterval=600 $SERVER_USER@$SERVER_ADDR bash < ~/update_script.sh
      #     python3 ci_cd_tools/scripts/odoo_update_addons.py "$ODOO_USER" "$ODOO_PASSWORD" "$ODOO_URI" "$ODOO_DB"
      # - name: Hard update (base module)
      #   if: ${{inputs.base_update}}
      #   run: |
      #     cat <<EOF >> ~/update_script.sh
      #     echo "=== UPDATING ODOO ==="
      #     sudo systemctl stop $ODOO_SERVICE
      #     cd $MAIN_PATH
      #     source venv/bin/activate
      #     python3 odoo-bin -c config/odoo-server.conf -d $ODOO_DB -u base --logfile= --log-level=error --stop-after-init
      #     deactivate
      #     sudo systemctl start $ODOO_SERVICE
      #     sudo systemctl status $ODOO_SERVICE
      #     EOF
      #     ssh -o ServerAliveInterval=600 $SERVER_USER@$SERVER_ADDR bash < ~/update_script.sh
